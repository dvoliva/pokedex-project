# =============================================================================
# ci.yml - pipeline de integracion continua para el proyecto pokedex
#
# este workflow se ejecuta en cada push o pull request a main y realiza:
# 1. linting: verifica calidad del codigo con flake8
# 2. tests: ejecuta la suite de pruebas con postgresql real
# 3. docker: verifica que la imagen se construye correctamente
#
# los jobs se ejecutan en secuencia: lint -> test -> docker
# si alguno falla, los siguientes no se ejecutan
# =============================================================================

name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# cancela ejecuciones anteriores del mismo branch para evitar duplicados
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # job 1: linting - verifica calidad del codigo (rapido, sin db)
  # ---------------------------------------------------------------------------
  lint:
    name: code quality
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: install flake8
        run: pip install flake8

      - name: lint with flake8
        run: |
          # errores criticos: sintaxis, imports rotos, variables no definidas
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # advertencias de estilo (no bloquean el build)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # ---------------------------------------------------------------------------
  # job 2: tests - ejecuta tests con postgresql real
  # ---------------------------------------------------------------------------
  test:
    name: run tests
    runs-on: ubuntu-latest
    needs: lint

    # variables de entorno para django
    env:
      SECRET_KEY: 'clave-temporal-para-ci-github'
      DEBUG: 'True'
      DATABASE_URL: postgres://oak_user:password_secreta_ci@localhost:5432/pokedex_db

    # servicio de postgresql para los tests
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: pokedex_db
          POSTGRES_USER: oak_user
          POSTGRES_PASSWORD: password_secreta_ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: set up python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # cache de dependencias para acelerar ejecuciones posteriores
      - name: cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: run migrations
        run: python src/manage.py migrate

      - name: run tests
        run: python src/manage.py test pokemons

  # ---------------------------------------------------------------------------
  # job 3: docker - verifica que la imagen se construye correctamente
  # ---------------------------------------------------------------------------
  docker:
    name: build docker image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      # construye la imagen con el sha del commit como tag
      - name: build docker image
        run: docker build -t pokedex-app:${{ github.sha }} .

      - name: verify image was created
        run: docker images pokedex-app:${{ github.sha }}